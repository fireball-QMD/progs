#include "../include/dprec.fh"
module qm2_extern_fb_module
! ----------------------------------------------------------------
! Interface for Fireball based QM and QM/MM MD 
!
! Currently supports:
! pure QM
! QM/MM with cutoff for QM-MM electrostatics under periodic
! boundary conditions
!
! Author: Jesus I. Mendieta-Moreno (jesus.mendieta@uam.es)
!
! Date: November 2010
!
! ----------------------------------------------------------------

  use qm2_extern_util_module, only: debug_enter_function, debug_exit_function

  implicit none

  private
  public :: get_fb_forces, fb_finalize
  logical, save :: do_mpi = .false.  ! Used in finalize subroutine

  character(len=*), parameter :: module_name = "qm2_extern_fb_module"

  type fb_nml_type
        ! Poner los input de fireball
     character(len=20) :: executable
     integer :: max_scf_iterations
     integer :: qmmm_int
     integer :: idftd3
     integer :: debug
     integer :: mpi
     integer :: iqout
     integer :: imcweda
     integer :: ihorsfield
     integer :: iensemble
     integer :: imdet
     integer :: nddt
     integer :: icluster
     integer :: iwrtpop
     integer :: iwrtvel
     integer :: iwrteigen
     integer :: iwrtefermi
     integer :: iwrtdos
     integer :: ifixcharge
     integer :: iwrtewf
     integer :: iwrtatom
     integer :: iewform
     integer :: npbands
     integer, dimension(200) :: pbands     
  end type fb_nml_type

  integer, save         :: newcomm ! Initialized in mpi_init subroutine

contains

  ! --------------------------------------
  ! Get QM energy and forces from TeraChem
  ! --------------------------------------
  subroutine get_fb_forces( do_grad, nstep, ntpr_default, id, nqmatoms, qmcoords,&
       qmtypes, nclatoms, clcoords, escf, dxyzqm, dxyzcl, charge, spinmult )

    use qm2_extern_util_module, only: print_results, check_installation, write_dipole, write_charges
    use constants, only: CODATA08_AU_TO_KCAL, CODATA08_A_TO_BOHRS, ZERO

    logical, intent(in) :: do_grad              ! Return gradient/not
    integer, intent(in) :: nstep                ! MD step number
    integer, intent(in) :: ntpr_default         ! frequency of printing
    character(len=3), intent(in) :: id          ! ID number for PIMD or REMD
    integer, intent(in) :: nqmatoms             ! Number of QM atoms
    _REAL_,  intent(in) :: qmcoords(3,nqmatoms) ! QM coordinates
    integer, intent(in) :: qmtypes(nqmatoms)    ! QM atom types (nuclear charge in au)
    integer, intent(in) :: nclatoms             ! Number of MM atoms
    _REAL_,  intent(in) :: clcoords(4,nclatoms) ! MM coordinates and charges in au
    _REAL_, intent(out) :: escf                 ! SCF energy
    _REAL_, intent(out) :: dxyzqm(3,nqmatoms)   ! SCF QM force
    _REAL_, intent(out) :: dxyzcl(3,nclatoms)   ! SCF MM force
    integer, intent(in) :: charge, spinmult     ! Charge and spin multiplicity

    _REAL_              :: dipmom(4,3)          ! Dipole moment {x, y, z, |D|}, {QM, MM, TOT}
    _REAL_              :: qmcharges(nqmatoms)  ! QM charges from population analysis

    type(fb_nml_type), save :: fb_nml
    logical, save :: first_call = .true.
    integer :: i
    integer :: printed =-1 ! Used to tell if we have printed this step yet 
                           ! since the same step may be called multiple times
    character(len=150) :: call_buffer

    ! assemble input - / output data filenames

    
    ! Setup on first program call
    if ( first_call ) then
      first_call = .false.
      write (6,*) '>>> Running QM calculation with Fireball  <<<'
      write(6,*) 'call get_namelist( ntpr_default, fb_nml )',ntpr_default,fb_nml
      call get_namelist( fb_nml )
      call check_installation( trim(fb_nml%executable), id, .true., fb_nml%debug )
     ! call print_namelist(fb_nml)
    end if

      call mpi_hook( nqmatoms, qmcoords, qmtypes, nclatoms, clcoords,&
        fb_nml, escf, dxyzqm, dxyzcl, dipmom, qmcharges, do_grad, id, charge, spinmult )

    if ( do_grad ) then
       ! Convert Hartree/Bohr -> kcal/(mol*A)
       dxyzqm(:,:) = dxyzqm(:,:) !* 14.39975d0 * 23.061d0
       if ( nclatoms > 0 ) then
          dxyzcl(:,:) = dxyzcl(:,:)
       end if
    else
       dxyzqm = ZERO
       if ( nclatoms > 0 ) dxyzcl = ZERO
    end if

    !escf = escf * CODATA08_AU_TO_KCAL



  end subroutine get_fb_forces


  subroutine get_namelist(fb_nml)

    use UtilitiesModule, only: Upcase
    implicit none
    character(len=20) :: executable
    !integer, intent(in) :: ntpr_default
    type(fb_nml_type), intent(out) :: fb_nml
    integer :: mpi, max_scf_iterations, qmmm_int, idftd3, debug, iqout, iensemble,        &
               imcweda, ihorsfield, imdet, nddt, icluster, iwrtpop, iwrtvel, iwrteigen,   &
               iwrtefermi, iwrtdos, ifixcharge, iwrtewf, iwrtatom, iewform, npbands
    integer, dimension(200) :: pbands
    namelist /fb/ mpi, executable, max_scf_iterations, qmmm_int, idftd3, debug, iqout,   &
               imcweda, ihorsfield, iensemble, imdet, nddt, icluster, iwrtpop, iwrtvel,  &
               iwrteigen, iwrtefermi, iwrtdos, ifixcharge, iwrtewf, iwrtatom,         &
               iewform, npbands, pbands
    integer :: i, ierr
     executable      = 'fireball_server'
   


    ! Default values
    executable = 'fireball_server'
    max_scf_iterations = 70
    qmmm_int = 1
    idftd3 = 0
    debug = 0
    mpi = 1
    iqout = 1
    imcweda = 1
    ihorsfield = 0
    iensemble = 0
    imdet = 0
    nddt = 1000
    icluster = 1
    iwrtpop = 0
    iwrtvel = 0
    iwrteigen = 0
    iwrtefermi = 0 
    iwrtdos = 0
    ifixcharge = 0
    iwrtewf = 0
    iwrtatom = 0
    iewform = 0
    npbands = 0
    pbands = 0

    ! Read namelist, 
    rewind 5
    read(5,nml=fb,iostat=ierr)


    ! Assign namelist values to fb_nml data type
    fb_nml%executable           = executable
    fb_nml%max_scf_iterations   = max_scf_iterations
    fb_nml%qmmm_int             = qmmm_int
    fb_nml%idftd3               = idftd3
    fb_nml%debug                = debug
    fb_nml%iqout                = iqout
    fb_nml%imcweda              = imcweda
    fb_nml%ihorsfield           = ihorsfield
    fb_nml%iensemble            = iensemble
    fb_nml%imdet                = imdet
    fb_nml%nddt                 = nddt
    fb_nml%icluster             = icluster  
    fb_nml%iwrtpop              = iwrtpop
    fb_nml%iwrtvel              = iwrtvel
    fb_nml%iwrteigen            = iwrteigen
    fb_nml%iwrtefermi           = iwrtefermi  
    fb_nml%iwrtdos              = iwrtdos
    fb_nml%ifixcharge           = ifixcharge
    fb_nml%iwrtewf              = iwrtewf
    fb_nml%iwrtatom             = iwrtatom
    fb_nml%iewform              = iewform
    fb_nml%npbands              = npbands
    fb_nml%pbands               = pbands

    ! Need this variable so we don't call MPI_Send in the finalize subroutine

  end subroutine get_namelist

  ! --------------------------------
  ! Print Fireball namelist settings
  ! --------------------------------
  subroutine write_inpfile( fb_nml, qmcoords, nqmatoms, charge)

    use qmmm_module, only : qmmm_struct

    implicit none
    type(fb_nml_type), intent(in) :: fb_nml
    _REAL_           , intent(in) :: qmcoords(:,:)
    integer          , intent(in) :: charge
    integer          , intent(in) :: nqmatoms
    integer :: k

    open (unit = 226, file = 'fireball.in', status = 'unknown')

    write (226,600) "&option"
    
    if (fb_nml%ihorsfield .eq. 1) then
    write (226,600) "imcweda = 0"
    write (226,600) "ihorsfield = 1"
    end if
    write (226,601) "qstate = ", -1*charge
    write (226,602) "icluster = ", fb_nml%icluster
    write (226,602) "iqout = ", fb_nml%iqout
    write (226,603) "max_scf_iterations = ", fb_nml%max_scf_iterations
    write (226,602) "iensemble = ", fb_nml%iensemble
    write (226,602) "imdet = ", fb_nml%imdet
    write (226,605) "nddt = ", fb_nml%nddt
    write (226,602) "iqmmm = ", fb_nml%qmmm_int
    write (226,602) "ifixcharge =",fb_nml%ifixcharge
    write (226,600) 'iquench = 4'
    write (226,602) "idftd3 =",fb_nml%idftd3
    write (226,600) "&end"
    write (226,600) "&output"
    write (226,600) "iwrtcharges = 1" 
    write (226,602) "iwrtpop = ", fb_nml%iwrtpop
    write (226,602) "iwrtvel = ", fb_nml%iwrtvel
    write (226,602) "iwrteigen = ", fb_nml%iwrteigen
    write (226,602) "iwrtefermi = ", fb_nml%iwrtefermi
    write (226,602) "iwrtdos = ", fb_nml%iwrtdos
    write (226,602) "iwrtewf =",fb_nml%iwrtewf
    write (226,602) "iwrtatom =",fb_nml%iwrtatom
    write (226,600) "&end"
    if (fb_nml%iwrtewf .eq. 1) then
    write (226,600) "&mesh"
    write (226,603) "iewform = ", fb_nml%iewform
    write (226,603) "npbands = ", fb_nml%npbands
    write (226,608) "pbands = ", fb_nml%pbands
    write (226,600) "&end"
    end if

    open (unit = 227, file = 'input.bas', status = 'unknown')

    write (227,*) nqmatoms
    do k = 1, nqmatoms
      write (227,700) qmmm_struct%iqm_atomic_numbers(k), qmcoords(:,k)
    end do



! Format Statements
! ===========================================================================
600     format (a)!(a,f8.5)
601     format (a,i2)
602     format (a,i1)
603     format (a,i3)
604     format (a,i1)
605     format (a,i4)
608     format (a,199(i4,','),i3)
700     format (i2, 3(2x,f8.4))

  end subroutine write_inpfile



  ! Perform MPI communications with terachem. Requires MPI 2.0 or above to use
  subroutine mpi_hook( nqmatoms, qmcoords, qmtypes, nclatoms, clcoords,&
       fb_nml, escf, dxyzqm, dxyzcl, dipmom, qmcharges, do_grad, id, charge, spinmult )
    
    use ElementOrbitalIndex, only : elementSymbol
    use qm2_extern_util_module, only: check_installation    
    
    implicit none

    integer, intent(in) :: nqmatoms
    _REAL_,  intent(in) :: qmcoords(3,nqmatoms) 
    integer, intent(in) :: qmtypes(nqmatoms)
    integer, intent(in) :: nclatoms
    _REAL_,  intent(in) :: clcoords(4,nclatoms)
    type(fb_nml_type), intent(in) :: fb_nml
    _REAL_, intent(out) :: escf
    _REAL_, intent(out) :: dxyzqm(3,nqmatoms)
    _REAL_, intent(out) :: dxyzcl(3,nclatoms)
    _REAL_, intent(out) :: dipmom(4,3)
    _REAL_, intent(out) :: qmcharges(nqmatoms)
    logical, intent(in) :: do_grad
    character(len=3), intent(in) :: id
    integer         , intent(in) :: charge, spinmult

    character(len=2)    :: atom_types(nqmatoms)
    _REAL_              :: coords(3,nqmatoms+nclatoms)
    _REAL_              :: charges(nclatoms)
    _REAL_              :: dxyz_all(3,nclatoms+nqmatoms)

    logical,save        :: first_call=.true.
    integer             :: i
    integer             :: ierr
    integer             :: itime_step

    integer :: system
    integer :: stat

    call debug_enter_function( 'mpi_hook', module_name, fb_nml%debug )


    ! ---------------------------------------------------
    ! Initialization: Connect to "terachem_port", set    
    ! newcomm (global), send relevant namelist variables.
    ! ---------------------------------------------------

    write(6,*)'dgt connect', first_call


    if (first_call) then 
      first_call=.false.
      call write_inpfile( fb_nml, qmcoords, nqmatoms, charge)
      call initbasics ()
      call readdata ()
      itime_step = 0
    end if

      itime_step = itime_step +1
       call fireball_qmmm_loop(itime_step,qmcoords,nclatoms,clcoords,escf,dxyzqm,dxyzcl)
print*,'escf=',escf

    do i=1,nqmatoms
     write (*,'(2x, 3(2x,f12.6))') qmcoords(:,i)
    end do



  end subroutine mpi_hook




  subroutine fb_finalize()

    implicit none


  end subroutine fb_finalize
      

end module qm2_extern_fb_module
